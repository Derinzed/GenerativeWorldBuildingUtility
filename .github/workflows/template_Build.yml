name: template_Build

on:
  workflow_call:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x' # adjust as needed

      - name: Add GitHub NuGet source
        run: dotnet nuget add source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --name github --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text

      - name: Restore dependencies
        run: dotnet restore ./GenerativeWorldBuildingUtility.csproj

      - name: Build Release
        run: dotnet build ./GenerativeWorldBuildingUtility.csproj --configuration Release --no-restore
        working-directory: ${{ github.workspace }}

      - name: Build AdminOverride
        run: dotnet build ./GenerativeWorldBuildingUtility.csproj --configuration AdminOverride --no-restore
        working-directory: ${{ github.workspace }}

      - name: Build ReleaseFullSubscription
        run: dotnet build ./GenerativeWorldBuildingUtility.csproj --configuration ReleaseFullSubscription --no-restore
        working-directory: ${{ github.workspace }}

      - name: Build ReleaseLimitedSubscription
        run: dotnet build ./GenerativeWorldBuildingUtility.csproj --configuration ReleaseLimitedSubscription --no-restore
        working-directory: ${{ github.workspace }}

      - name: Upload artifacts for each package
        shell: pwsh
        run: |
          Get-ChildItem -Path ./Publish -Directory | ForEach-Object {
            $name = $_.Name
            Write-Host "Zipping $name"
            $zipPath = "$name.zip"
            Compress-Archive -Path $_.FullName -DestinationPath $zipPath -Force
            
            Write-Host "::group::Uploading $name"
            gh release upload ${{ github.ref_name }} $zipPath --clobber
            Write-Host "::endgroup::"
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

